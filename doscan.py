#!/usr/bin/env python
import requests
import re
import urlparse
from bs4 import BeautifulSoup

class VulnScanner:
    def __init__(self, url):
        self.session = requests.Session()
        self.target_website = url
        self.found_links = []
        self.v = 0

    def get_links(self, webpage):
        page = self.session.get(webpage).content
        return re.findall('(?:href=")(.*?)"', page)

    def seek_page(self, target_site=None):
        if target_site == None:
            target_page = "http://" + self.target_website
        else:
            target_page = target_site
        links = self.get_links(target_page)
        for link in links:
            link = urlparse.urljoin(target_page, link)
            if self.target_website.split(".")[0] in link and link not in self.found_links and "#" not in link and "logout" not in link:
                self.found_links.append(link)
                print("[+] " + link)
                self.test_vuln(link)
                self.seek_page(link)

    def get_forms(self, page):
        resp = self.session.get(page)
        page_html = BeautifulSoup(resp.content, features="lxml")
        return page_html.findAll("form")

    def submit_form(self, url, form, payload):
        action = form.get("action")
        post_url = urlparse.urljoin(url, action)
        method = form.get("method")

        input_list = form.findAll("input")
        post_data = {}
        for input in input_list:
            name = input.get("name")
            type = input.get("type")
            value = input.get("value")
            if type == "text":
                value = payload
            post_data[name] = value
        try:
            if method == "POST" or method == "post":
                return self.session.post(post_url, data=post_data)
            return self.session.get(post_url, params=post_data)
        except requests.exceptions.InvalidSchema:
            pass

    def test_xxs_forms(self, url, form):
        payload = "<sCript>alert('XSS')</scriPt>"
        try:
            resp = self.submit_form(url, form, payload).content
        except AttributeError:
            resp = "Empty"
        return [payload in resp, payload]

    def test_xxs_link(self, link):
        payload = "<sCript>alert('XSS')</scriPt>"
        link = link.replace("=", "=" + payload)
        resp = self.session.get(link).content
        return [payload in resp, payload]

    def test_vuln(self, link):
        forms = self.get_forms(link)
        if "=" in link:
            print("\t[+] Testing " + link)
            result = self.test_xxs_link(link)
            if result[0]:
                print('\n\n\t\t' + '[***] Found XSS with payload ' + '"' + result[1] + '"\n')
                self.v += 1

        for form in forms:
            print("\t[+] Testing form in " + link)
            result = self.test_xxs_forms(link, form)
            if result[0]:
                print('\n\n\t\t' + '[***] Found XSS with payload ' + '"' + result[1] + '"\n')
                self.v += 1
        return 0

    def startscan(self):
        self.seek_page()
        return self.v